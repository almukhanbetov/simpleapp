name: CI/CD Deploy SimpleApp

on:
  push:
    branches: [ "main" ]

env:
  IMAGE_NAME: almuko/simpleapp

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ env.IMAGE_NAME }}:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: latest

      - name: Setup Kubeconfig
        shell: bash
        run: |
          mkdir -p $HOME/.kube
          cat > $HOME/.kube/config <<'EOF'
          ${{ secrets.KUBECONFIG }}
          EOF

      # ðŸ‘‡ Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¹ ÑˆÐ°Ð³
      - name: Ensure DB Secret exists
        run: |
          kubectl delete secret simpleapp-db-secret -n default --ignore-not-found
          kubectl create secret generic simpleapp-db-secret \
            -n default \
            --from-literal=DATABASE_URL="postgres://postgres:Zxcvbnm123@postgres:5432/simpleapp?sslmode=disable"

      - name: Run DB migrations
        run: |
          set -e
          kubectl delete job simpleapp-migrate -n default --ignore-not-found=true
          kubectl apply -f k8s/migrate.yaml -n default
          # Ð¶Ð´ÐµÐ¼ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ
          if ! kubectl wait --for=condition=complete job/simpleapp-migrate -n default --timeout=120s; then
            echo "âŒ Migration job failed. Dumping debug info..."
            kubectl describe job simpleapp-migrate -n default || true
            kubectl get pods -n default -l job-name=simpleapp-migrate -o wide || true
            kubectl logs job/simpleapp-migrate -n default || true
            exit 1
          fi
          echo "âœ… Migration job completed successfully."
          echo "ðŸ“œ Logs from migration job:"
          kubectl logs job/simpleapp-migrate -n default

      - name: Deploy SimpleApp
        run: |
          kubectl apply -f k8s/simpleapp.yaml -n default
          kubectl rollout status deployment/simpleapp -n default
